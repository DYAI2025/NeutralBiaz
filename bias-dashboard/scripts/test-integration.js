#!/usr/bin/env node\n\n/**\n * Integration testing script for BiasNeutralizeAI\n * \n * This script tests the complete integration between the React frontend\n * and FastAPI backend by running both services and executing tests.\n */\n\nconst { spawn } = require('child_process');\nconst path = require('path');\nconst fs = require('fs');\nconst { promisify } = require('util');\nconst { performance } = require('perf_hooks');\n\nconst sleep = promisify(setTimeout);\n\n// Configuration\nconst CONFIG = {\n  backend: {\n    path: '../bias-engine',\n    command: 'python',\n    args: ['-m', 'uvicorn', 'bias_engine.main:app', '--host', '0.0.0.0', '--port', '8000'],\n    healthUrl: 'http://localhost:8000/api/v1/health',\n    timeout: 30000 // 30 seconds\n  },\n  frontend: {\n    path: '.',\n    command: 'npm',\n    args: ['run', 'test', '--', '--watchAll=false', '--testPathPattern=integration'],\n    timeout: 60000 // 60 seconds\n  },\n  delays: {\n    backendStartup: 5000, // 5 seconds\n    healthCheck: 1000, // 1 second between health checks\n    frontendStartup: 2000 // 2 seconds\n  }\n};\n\n// Utility functions\nconst log = {\n  info: (msg) => console.log(`\\x1b[36m[INFO]\\x1b[0m ${msg}`),\n  success: (msg) => console.log(`\\x1b[32m[SUCCESS]\\x1b[0m ${msg}`),\n  error: (msg) => console.log(`\\x1b[31m[ERROR]\\x1b[0m ${msg}`),\n  warning: (msg) => console.log(`\\x1b[33m[WARNING]\\x1b[0m ${msg}`),\n  step: (step, total, msg) => console.log(`\\x1b[35m[${step}/${total}]\\x1b[0m ${msg}`)\n};\n\nconst checkHealth = async (url, timeout = 5000) => {\n  try {\n    const { default: fetch } = await import('node-fetch');\n    const response = await Promise.race([\n      fetch(url),\n      new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), timeout))\n    ]);\n    \n    if (response.ok) {\n      const data = await response.json();\n      return { healthy: true, data };\n    }\n    return { healthy: false, status: response.status };\n  } catch (error) {\n    return { healthy: false, error: error.message };\n  }\n};\n\nconst spawnProcess = (command, args, options = {}) => {\n  return new Promise((resolve, reject) => {\n    const process = spawn(command, args, {\n      stdio: ['pipe', 'pipe', 'pipe'],\n      shell: true,\n      ...options\n    });\n\n    let stdout = '';\n    let stderr = '';\n\n    process.stdout.on('data', (data) => {\n      stdout += data.toString();\n    });\n\n    process.stderr.on('data', (data) => {\n      stderr += data.toString();\n    });\n\n    process.on('close', (code) => {\n      if (code === 0) {\n        resolve({ success: true, stdout, stderr, code });\n      } else {\n        reject({ success: false, stdout, stderr, code });\n      }\n    });\n\n    process.on('error', (error) => {\n      reject({ success: false, error: error.message });\n    });\n\n    // Store process reference for cleanup\n    process._options = options;\n    return process;\n  });\n};\n\nconst waitForHealthy = async (url, maxAttempts = 30) => {\n  for (let i = 0; i < maxAttempts; i++) {\n    const health = await checkHealth(url);\n    if (health.healthy) {\n      return health.data;\n    }\n    \n    if (i < maxAttempts - 1) {\n      await sleep(CONFIG.delays.healthCheck);\n    }\n  }\n  \n  throw new Error(`Service not healthy after ${maxAttempts} attempts`);\n};\n\n// Main test execution\nasync function runIntegrationTests() {\n  const startTime = performance.now();\n  let backendProcess = null;\n  \n  try {\n    log.step(1, 6, 'Starting integration test suite');\n    \n    // Step 1: Check prerequisites\n    log.step(2, 6, 'Checking prerequisites');\n    \n    const backendPath = path.resolve(CONFIG.backend.path);\n    if (!fs.existsSync(backendPath)) {\n      throw new Error(`Backend path not found: ${backendPath}`);\n    }\n    \n    const frontendPath = path.resolve(CONFIG.frontend.path);\n    if (!fs.existsSync(path.join(frontendPath, 'package.json'))) {\n      throw new Error(`Frontend package.json not found in: ${frontendPath}`);\n    }\n    \n    log.success('Prerequisites check passed');\n    \n    // Step 2: Start backend service\n    log.step(3, 6, 'Starting FastAPI backend');\n    \n    backendProcess = spawn(CONFIG.backend.command, CONFIG.backend.args, {\n      cwd: backendPath,\n      stdio: ['pipe', 'pipe', 'pipe'],\n      shell: true,\n      detached: false\n    });\n    \n    // Monitor backend output\n    let backendReady = false;\n    backendProcess.stdout.on('data', (data) => {\n      const output = data.toString();\n      if (output.includes('Uvicorn running') || output.includes('Application startup complete')) {\n        backendReady = true;\n      }\n      if (process.env.VERBOSE) {\n        console.log(`[BACKEND] ${output.trim()}`);\n      }\n    });\n    \n    backendProcess.stderr.on('data', (data) => {\n      const output = data.toString();\n      if (process.env.VERBOSE) {\n        console.error(`[BACKEND ERROR] ${output.trim()}`);\n      }\n    });\n    \n    // Wait for backend to start\n    log.info('Waiting for backend to start...');\n    await sleep(CONFIG.delays.backendStartup);\n    \n    // Step 3: Wait for backend health\n    log.step(4, 6, 'Waiting for backend health check');\n    \n    const healthData = await waitForHealthy(CONFIG.backend.healthUrl);\n    log.success(`Backend is healthy: ${JSON.stringify(healthData, null, 2)}`);\n    \n    // Step 4: Run frontend integration tests\n    log.step(5, 6, 'Running frontend integration tests');\n    \n    await sleep(CONFIG.delays.frontendStartup);\n    \n    const testResult = await spawnProcess(\n      CONFIG.frontend.command,\n      CONFIG.frontend.args,\n      {\n        cwd: frontendPath,\n        env: {\n          ...process.env,\n          VITE_API_BASE_URL: 'http://localhost:8000',\n          NODE_ENV: 'test'\n        },\n        timeout: CONFIG.frontend.timeout\n      }\n    );\n    \n    // Step 5: Analyze results\n    log.step(6, 6, 'Analyzing test results');\n    \n    if (testResult.success) {\n      log.success('All integration tests passed!');\n      \n      // Parse test output for metrics\n      const testOutput = testResult.stdout;\n      const passedMatch = testOutput.match(/(\\d+) passed/);\n      const failedMatch = testOutput.match(/(\\d+) failed/);\n      const timeMatch = testOutput.match(/Time:\\s+([\\d.]+)\\s*s/);\n      \n      const metrics = {\n        passed: passedMatch ? parseInt(passedMatch[1]) : 0,\n        failed: failedMatch ? parseInt(failedMatch[1]) : 0,\n        duration: timeMatch ? parseFloat(timeMatch[1]) : 0\n      };\n      \n      log.info(`Test metrics: ${JSON.stringify(metrics, null, 2)}`);\n    } else {\n      log.error('Integration tests failed!');\n      console.log('STDOUT:', testResult.stdout);\n      console.log('STDERR:', testResult.stderr);\n      throw new Error(`Tests failed with exit code ${testResult.code}`);\n    }\n    \n    const totalTime = ((performance.now() - startTime) / 1000).toFixed(2);\n    log.success(`Integration test suite completed successfully in ${totalTime}s`);\n    \n  } catch (error) {\n    log.error(`Integration test failed: ${error.message}`);\n    \n    if (error.stdout) {\n      console.log('\\n--- STDOUT ---');\n      console.log(error.stdout);\n    }\n    \n    if (error.stderr) {\n      console.log('\\n--- STDERR ---');\n      console.log(error.stderr);\n    }\n    \n    process.exit(1);\n    \n  } finally {\n    // Cleanup\n    if (backendProcess && !backendProcess.killed) {\n      log.info('Cleaning up backend process...');\n      backendProcess.kill('SIGTERM');\n      \n      // Wait for graceful shutdown\n      await sleep(2000);\n      \n      if (!backendProcess.killed) {\n        backendProcess.kill('SIGKILL');\n      }\n    }\n  }\n}\n\n// CLI handling\nif (require.main === module) {\n  const args = process.argv.slice(2);\n  \n  if (args.includes('--help') || args.includes('-h')) {\n    console.log(`\nBiasNeutralizeAI Integration Test Runner\n\nUsage: node test-integration.js [options]\n\nOptions:\n  --verbose    Show detailed output from backend and tests\n  --help, -h   Show this help message\n\nEnvironment Variables:\n  VERBOSE=1    Same as --verbose flag\n\nExample:\n  npm run test:integration\n  VERBOSE=1 node scripts/test-integration.js\n`);\n    process.exit(0);\n  }\n  \n  if (args.includes('--verbose')) {\n    process.env.VERBOSE = '1';\n  }\n  \n  runIntegrationTests().catch((error) => {\n    log.error(`Fatal error: ${error.message}`);\n    process.exit(1);\n  });\n}\n\nmodule.exports = {\n  runIntegrationTests,\n  checkHealth,\n  CONFIG\n};