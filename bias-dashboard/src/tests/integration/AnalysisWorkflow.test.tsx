import { render, screen, fireEvent, waitFor } from '@testing-library/react';\nimport { QueryClient, QueryClientProvider } from '@tanstack/react-query';\nimport { rest } from 'msw';\nimport { setupServer } from 'msw/node';\nimport React from 'react';\nimport AnalysisPage from '../../pages/AnalysisPage';\nimport { AnalysisResult, BiasDetection, BiasLevel, BiasType } from '../../types/api';\n\n// Mock API responses\nconst mockAnalysisResult: AnalysisResult = {\n  text: 'The candidate should be able to handle the pressures of this role.',\n  language: 'en',\n  overall_bias_score: 0.65,\n  bias_level: BiasLevel.MEDIUM,\n  detections: [\n    {\n      type: BiasType.GENDER,\n      level: BiasLevel.MEDIUM,\n      confidence: 0.75,\n      description: 'Potential gender bias detected in language usage',\n      affected_text: 'The candidate should be able to handle',\n      start_position: 0,\n      end_position: 35,\n      suggestions: [\n        'Consider using more neutral language',\n        'Replace with inclusive terms'\n      ]\n    }\n  ],\n  neutralized_text: 'The applicant should be able to handle the pressures of this role.',\n  processing_time: 1.2,\n  model_version: 'test-v1.0.0'\n};\n\n// MSW server setup\nconst server = setupServer(\n  rest.post('http://localhost:8000/api/v1/analyze', (req, res, ctx) => {\n    return res(ctx.json(mockAnalysisResult));\n  }),\n  rest.get('http://localhost:8000/api/v1/health', (req, res, ctx) => {\n    return res(ctx.json({ status: 'ok', timestamp: new Date().toISOString() }));\n  }),\n  rest.get('http://localhost:8000/api/v1/config', (req, res, ctx) => {\n    return res(ctx.json({\n      app_name: 'BiasNeutralizeAI',\n      app_version: '1.0.0',\n      environment: 'test',\n      supported_languages: ['en', 'es', 'fr'],\n      supported_bias_types: [BiasType.GENDER, BiasType.RACIAL, BiasType.AGE],\n      cultural_profiles: ['neutral', 'western', 'eastern'],\n      analysis_modes: ['fast', 'accurate', 'comprehensive'],\n      default_settings: {}\n    }));\n  })\n);\n\nbeforeAll(() => server.listen());\nafterEach(() => server.resetHandlers());\nafterAll(() => server.close());\n\nconst createWrapper = () => {\n  const queryClient = new QueryClient({\n    defaultOptions: {\n      queries: {\n        retry: false,\n      },\n      mutations: {\n        retry: false,\n      },\n    },\n  });\n\n  return ({ children }: { children: React.ReactNode }) => (\n    <QueryClientProvider client={queryClient}>\n      {children}\n    </QueryClientProvider>\n  );\n};\n\ndescribe('Analysis Workflow Integration', () => {\n  it('should complete full analysis workflow', async () => {\n    const Wrapper = createWrapper();\n    render(\n      <Wrapper>\n        <AnalysisPage />\n      </Wrapper>\n    );\n\n    // Check page loads\n    expect(screen.getByText('Bias Analysis Tool')).toBeInTheDocument();\n    \n    // Find and fill text input\n    const textInput = screen.getByPlaceholderText('Paste your text here for bias analysis...');\n    fireEvent.change(textInput, {\n      target: { value: 'The candidate should be able to handle the pressures of this role.' }\n    });\n\n    // Submit analysis\n    const analyzeButton = screen.getByRole('button', { name: /analyze text/i });\n    fireEvent.click(analyzeButton);\n\n    // Wait for loading state\n    expect(screen.getByText('Analyzing...')).toBeInTheDocument();\n\n    // Wait for results\n    await waitFor(() => {\n      expect(screen.getByText('Text Analysis')).toBeInTheDocument();\n    });\n\n    // Check bias heatmap is displayed\n    expect(screen.getByText('1 bias marker detected')).toBeInTheDocument();\n    \n    // Check side-by-side comparison\n    expect(screen.getByText('Original vs. Neutralized Text')).toBeInTheDocument();\n    expect(screen.getByText('The applicant should be able to handle the pressures of this role.')).toBeInTheDocument();\n\n    // Check marker explorer\n    expect(screen.getByText('Bias Markers (1)')).toBeInTheDocument();\n    expect(screen.getByText('\"The candidate should be able to handle\"')).toBeInTheDocument();\n\n    // Check analysis summary\n    expect(screen.getByText('Analysis Summary')).toBeInTheDocument();\n    expect(screen.getByText('65%')).toBeInTheDocument(); // Overall score\n  });\n\n  it('should handle API errors gracefully', async () => {\n    server.use(\n      rest.post('http://localhost:8000/api/v1/analyze', (req, res, ctx) => {\n        return res(ctx.status(500), ctx.json({ detail: 'Internal server error' }));\n      })\n    );\n\n    const Wrapper = createWrapper();\n    render(\n      <Wrapper>\n        <AnalysisPage />\n      </Wrapper>\n    );\n\n    const textInput = screen.getByPlaceholderText('Paste your text here for bias analysis...');\n    fireEvent.change(textInput, {\n      target: { value: 'Test text with potential bias.' }\n    });\n\n    const analyzeButton = screen.getByRole('button', { name: /analyze text/i });\n    fireEvent.click(analyzeButton);\n\n    await waitFor(() => {\n      expect(screen.getByText('Analysis Error')).toBeInTheDocument();\n    });\n  });\n\n  it('should handle empty results', async () => {\n    server.use(\n      rest.post('http://localhost:8000/api/v1/analyze', (req, res, ctx) => {\n        return res(ctx.json({\n          ...mockAnalysisResult,\n          overall_bias_score: 0.1,\n          bias_level: BiasLevel.LOW,\n          detections: [],\n          neutralized_text: undefined\n        }));\n      })\n    );\n\n    const Wrapper = createWrapper();\n    render(\n      <Wrapper>\n        <AnalysisPage />\n      </Wrapper>\n    );\n\n    const textInput = screen.getByPlaceholderText('Paste your text here for bias analysis...');\n    fireEvent.change(textInput, {\n      target: { value: 'This is a neutral text.' }\n    });\n\n    const analyzeButton = screen.getByRole('button', { name: /analyze text/i });\n    fireEvent.click(analyzeButton);\n\n    await waitFor(() => {\n      expect(screen.getByText('0 bias markers detected')).toBeInTheDocument();\n    });\n\n    // Should show text analysis but not neutralized version\n    expect(screen.getByText('Text Analysis')).toBeInTheDocument();\n    expect(screen.queryByText('Original vs. Neutralized Text')).not.toBeInTheDocument();\n  });\n\n  it('should validate input requirements', () => {\n    const Wrapper = createWrapper();\n    render(\n      <Wrapper>\n        <AnalysisPage />\n      </Wrapper>\n    );\n\n    const analyzeButton = screen.getByRole('button', { name: /analyze text/i });\n    \n    // Button should be disabled initially\n    expect(analyzeButton).toBeDisabled();\n\n    // Add short text (less than minimum)\n    const textInput = screen.getByPlaceholderText('Paste your text here for bias analysis...');\n    fireEvent.change(textInput, { target: { value: 'Short' } });\n    \n    // Button should still be disabled\n    expect(analyzeButton).toBeDisabled();\n\n    // Add sufficient text\n    fireEvent.change(textInput, {\n      target: { value: 'This is a longer text that meets the minimum requirements.' }\n    });\n    \n    // Button should be enabled\n    expect(analyzeButton).not.toBeDisabled();\n  });\n\n  it('should allow configuration of analysis options', async () => {\n    const Wrapper = createWrapper();\n    render(\n      <Wrapper>\n        <AnalysisPage />\n      </Wrapper>\n    );\n\n    // Check that analysis mode selector is present\n    expect(screen.getByDisplayValue('Fast (Quick scan)')).toBeInTheDocument();\n    \n    // Check cultural context selector\n    expect(screen.getByDisplayValue('Neutral')).toBeInTheDocument();\n\n    // Wait for config to load and check bias type filters\n    await waitFor(() => {\n      expect(screen.getByText('Focus on Specific Bias Types (optional)')).toBeInTheDocument();\n    });\n\n    // Check bias type checkboxes are present\n    expect(screen.getByLabelText(/gender/i)).toBeInTheDocument();\n    expect(screen.getByLabelText(/racial/i)).toBeInTheDocument();\n  });\n});